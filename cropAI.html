<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CropAI - Your Smart Farming Partner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #22c55e; color: white; transform: translateX(4px); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .btn-primary { background-color: #22c55e; color: white; font-weight: 500; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s ease-in-out; cursor: pointer; }
        .btn-primary:hover { background-color: #16a34a; }
        .rec-tab.active { background-color: #22c55e; color: white; }
        .rec-section { display: none; }
        .rec-section.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="flex h-screen bg-white">
        <aside class="w-64 bg-gray-800 text-white flex flex-col p-4 fixed h-full">
            <div class="flex items-center mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain-circuit"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A3 3 0 1 0 12 18Z"/><path d="M9 12a4.5 4.5 0 0 0 4.5 4.5 4.5 4.5 0 0 0 4.5-4.5 4.5 4.5 0 0 0-4.5-4.5Z"/><path d="M12 11.5v-1"/><path d="M12 14v.5"/><path d="m10.422 10.422-.5.5"/><path d="m14.078 14.078-.5.5"/><path d="m10.422 13.656.5.5"/><path d="m14.078 9.922.5.5"/><path d="M14.5 12h-1"/><path d="M9.5 12h1"/><path d="M4.5 12H3"/><path d="M12 18v2.5"/><path d="M12 2.5V5"/></svg>
                <h1 class="text-2xl font-bold ml-2">CropAI</h1>
            </div>
            <nav class="flex-grow">
                <ul class="space-y-2">
                    <li><a href="#dashboard" class="sidebar-link flex items-center p-2 rounded-lg active"><span>Dashboard</span></a></li>
                    <li><a href="#crop-recommendation" class="sidebar-link flex items-center p-2 rounded-lg"><span>Crop Recommendation</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="ml-64 flex-1 p-8 overflow-y-auto bg-gray-100">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">Welcome, Farmer!</h2>
                    <p class="text-gray-500">Here's your farm's status for today.</p>
                </div>
            </header>
            <button id="open-crop-rec-modal" class="btn-primary">Get Crop Recommendation</button>
        </main>
    </div>

    <div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800"></h3>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="modalContent" class="p-6 text-gray-700 max-h-[60vh] overflow-y-auto"></div>
        </div>
    </div>
    
    <div id="cropRecModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">Crop Recommendation</h3>
                <button id="closeCropRecModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div class="p-6">
                <div id="manualSection" class="rec-section active space-y-4">
                    <p class="text-sm text-gray-500">Enter your soil nutrient values. Temperature and Rainfall are fetched automatically.</p>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="cropN" placeholder="Nitrogen (e.g., 90)" class="w-full p-2 border rounded-md">
                        <input type="number" id="cropP" placeholder="Phosphorus (e.g., 42)" class="w-full p-2 border rounded-md">
                        <input type="number" id="cropK" placeholder="Potassium (e.g., 43)" class="w-full p-2 border rounded-md">
                        <input type="number" id="cropPh" step="0.1" placeholder="pH (e.g., 6.5)" class="w-full p-2 border rounded-md">
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 text-right rounded-b-lg">
                <button id="getCropRecBtn" class="btn-primary w-full">Get Recommendation</button>
            </div>
        </div>
    </div>
    
<script>
    // Mock weather data for demonstration purposes
    const mockWeather = {
        temperature: 20.87,
        humidity: 82.0,
        rainfall: 202.9
    };

    document.addEventListener('DOMContentLoaded', () => {
        const appContainer = document.getElementById('app-container');
        appContainer.style.display = 'flex'; // Show the app

        const cropRecModal = document.getElementById('cropRecModal');
        const resultModal = document.getElementById('resultModal');

        const openCropRecModalBtn = document.getElementById('open-crop-rec-modal');
        const closeCropRecModalBtn = document.getElementById('closeCropRecModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const getCropRecBtn = document.getElementById('getCropRecBtn');

        // Function to show a generic result modal
        const showResultModal = (title, content) => {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalContent').innerHTML = content;
            resultModal.classList.remove('hidden');
        };

        openCropRecModalBtn.addEventListener('click', () => cropRecModal.classList.remove('hidden'));
        closeCropRecModalBtn.addEventListener('click', () => cropRecModal.classList.add('hidden'));
        closeModalBtn.addEventListener('click', () => resultModal.classList.add('hidden'));

        // =================================================================
        // == THIS IS THE NEW, MODIFIED CODE TO CALL YOUR FLASK BACKEND ==
        // =================================================================
        getCropRecBtn.addEventListener('click', async () => {
            // 1. Get user input values
            const n = document.getElementById('cropN').value;
            const p = document.getElementById('cropP').value;
            const k = document.getElementById('cropK').value;
            const ph = document.getElementById('cropPh').value;

            // 2. Simple validation
            if (!n || !p || !k || !ph) {
                showResultModal('Input Error', 'Please fill in all the fields.');
                return;
            }

            // 3. Prepare data payload for the API
            const data = {
                "N": parseFloat(n),
                "P": parseFloat(p),
                "K": parseFloat(k),
                "temperature": mockWeather.temperature, // Using mock data
                "humidity": mockWeather.humidity,       // Using mock data
                "ph": parseFloat(ph),
                "rainfall": mockWeather.rainfall        // Using mock data
            };

            // 4. Call the Flask API
            try {
                const response = await fetch('http://127.0.0.1:5000/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // 5. Display the result
                const recommendedCrop = result.crop_recommendation;
                const content = `<p class="text-lg">The most suitable crop for your farm is:</p>
                                 <p class="text-3xl font-bold text-green-600 mt-2 capitalize">${recommendedCrop}</p>`;
                showResultModal('AI Recommendation', content);
                cropRecModal.classList.add('hidden'); // Hide the input form

            } catch (error) {
                console.error("API call failed:", error);
                showResultModal('API Error', 'Could not connect to the recommendation server. Make sure your `app.py` is running.');
            }
        });
    });
</script>
</body>
</html>